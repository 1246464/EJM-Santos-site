{% extends "base.html" %}
{% block content %}
<div class="checkout-page">
  <h2>üí≥ Finalizar Pagamento</h2>

  <div class="checkout-container">
    <!-- Resumo do Pedido -->
    <div class="resumo-pedido">
      <h3>Resumo do Pedido</h3>
      
      {% for item in itens %}
      <div class="item-resumo">
        <span class="item-nome">{{ item.titulo }} ({{ item.quantidade }}x)</span>
        <span class="item-preco">R$ {{ "%.2f"|format(item.preco * item.quantidade) }}</span>
      </div>
      {% endfor %}

      <div class="total-pedido">
        <strong>Total:</strong>
        <strong>R$ {{ "%.2f"|format(total) }}</strong>
      </div>
    </div>

    <!-- Formul√°rio de Pagamento -->
    <div class="form-pagamento">
      <h3>üìç Endere√ßo de Entrega</h3>
      
      <form id="payment-form">
        <!-- Endere√ßos Salvos -->
        {% if saved_addresses %}
        <div class="endereco-section">
          <div class="saved-options">
            <label class="option-card">
              <input type="radio" name="address-option" value="saved" checked>
              <span>Usar endere√ßo salvo</span>
            </label>
            <label class="option-card">
              <input type="radio" name="address-option" value="new">
              <span>Adicionar novo endere√ßo</span>
            </label>
          </div>

          <div id="saved-addresses-list" class="saved-list">
            {% for addr in saved_addresses %}
            <label class="saved-item {% if addr.is_default %}default-item{% endif %}">
              <input type="radio" name="saved-address-id" value="{{ addr.id }}" {% if addr.is_default %}checked{% endif %}>
              <div class="saved-item-content">
                <strong>{{ addr.apelido }}</strong>
                {% if addr.is_default %}<span class="badge-default">Padr√£o</span>{% endif %}
                <div class="saved-item-details">
                  {{ addr.get_endereco_resumido() }}<br>
                  üìû {{ addr.telefone }}
                </div>
              </div>
            </label>
            {% endfor %}
          </div>

          <div id="new-address-form" class="form-section" style="display: none;">
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label for="rua">Rua/Avenida *</label>
                <input type="text" id="rua" name="rua" placeholder="Ex: Rua das Flores">
              </div>
              <div class="form-group" style="flex: 1;">
                <label for="numero">N√∫mero *</label>
                <input type="text" id="numero" name="numero" placeholder="123">
              </div>
            </div>

            <div class="form-group">
              <label for="complemento">Complemento</label>
              <input type="text" id="complemento" name="complemento" placeholder="Apto, bloco, casa...">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="bairro">Bairro *</label>
                <input type="text" id="bairro" name="bairro" placeholder="Centro">
              </div>
              <div class="form-group">
                <label for="cidade">Cidade *</label>
                <input type="text" id="cidade" name="cidade" placeholder="Sua cidade">
              </div>
            </div>

            <div class="form-group">
              <label for="telefone">Telefone/WhatsApp *</label>
              <input type="tel" id="telefone" name="telefone" placeholder="(11) 99999-9999">
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" id="save-address" name="save-address">
                Salvar este endere√ßo para pr√≥ximas compras
              </label>
            </div>

            <div class="form-group" id="address-nickname-group" style="display: none;">
              <label for="address-nickname">Apelido do endere√ßo</label>
              <input type="text" id="address-nickname" name="address-nickname" placeholder="Ex: Casa, Trabalho, Casa da m√£e">
            </div>
          </div>
        </div>
        {% else %}
        <!-- Nenhum endere√ßo salvo - mostrar formul√°rio direto -->
        <div class="endereco-section">
          <p class="info-message">üìç Voc√™ ainda n√£o tem endere√ßos salvos</p>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label for="rua">Rua/Avenida *</label>
              <input type="text" id="rua" name="rua" required placeholder="Ex: Rua das Flores">
            </div>
            <div class="form-group" style="flex: 1;">
              <label for="numero">N√∫mero *</label>
              <input type="text" id="numero" name="numero" required placeholder="123">
            </div>
          </div>

          <div class="form-group">
            <label for="complemento">Complemento</label>
            <input type="text" id="complemento" name="complemento" placeholder="Apto, bloco, casa...">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bairro">Bairro *</label>
              <input type="text" id="bairro" name="bairro" required placeholder="Centro">
            </div>
            <div class="form-group">
              <label for="cidade">Cidade *</label>
              <input type="text" id="cidade" name="cidade" required placeholder="Sua cidade">
            </div>
          </div>

          <div class="form-group">
            <label for="telefone">Telefone/WhatsApp *</label>
            <input type="tel" id="telefone" name="telefone" required placeholder="(11) 99999-9999">
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="save-address" name="save-address" checked>
              Salvar este endere√ßo para pr√≥ximas compras
            </label>
          </div>

          <div class="form-group">
            <label for="address-nickname">Apelido do endere√ßo</label>
            <input type="text" id="address-nickname" name="address-nickname" placeholder="Ex: Casa, Trabalho" value="Meu endere√ßo">
          </div>
        </div>
        {% endif %}

        <h3 style="margin-top: 30px;">üí≥ Dados do Cart√£o</h3>
        
        <!-- Cart√µes Salvos -->
        {% if saved_payment_methods %}
        <div class="payment-method-section">
          <div class="saved-options">
            <label class="option-card">
              <input type="radio" name="payment-option" value="saved" checked>
              <span>Usar cart√£o salvo</span>
            </label>
            <label class="option-card">
              <input type="radio" name="payment-option" value="new">
              <span>Adicionar novo cart√£o</span>
            </label>
          </div>

          <div id="saved-payment-methods-list" class="saved-list">
            {% for pm in saved_payment_methods %}
            <label class="saved-item {% if pm.is_default %}default-item{% endif %}">
              <input type="radio" name="saved-payment-method-id" value="{{ pm.id }}" {% if pm.is_default %}checked{% endif %}>
              <div class="saved-item-content">
                <strong>{{ pm.apelido }}</strong>
                {% if pm.is_default %}<span class="badge-default">Padr√£o</span>{% endif %}
                <div class="saved-item-details">
                  {{ pm.get_card_display() }}<br>
                  Validade: {{ "%02d"|format(pm.card_exp_month) }}/{{ pm.card_exp_year }}
                  {% if pm.is_expired() %}<span class="badge-expired">Expirado</span>{% endif %}
                </div>
              </div>
            </label>
            {% endfor %}
          </div>

          <div id="new-card-form" class="form-section" style="display: none;">
            <div class="form-group">
              <label for="card-element">Informa√ß√µes do Cart√£o</label>
              <div id="card-element">
                <!-- Stripe Element ser√° inserido aqui -->
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input type="checkbox" id="save-card" name="save-card">
                Salvar este cart√£o para pr√≥ximas compras
              </label>
            </div>

            <div class="form-group" id="card-nickname-group" style="display: none;">
              <label for="card-nickname">Apelido do cart√£o</label>
              <input type="text" id="card-nickname" name="card-nickname" placeholder="Ex: Cart√£o principal, Nubank">
            </div>
          </div>
        </div>
        {% else %}
        <!-- Nenhum cart√£o salvo - mostrar Stripe Element direto -->
        <div class="payment-method-section">
          <p class="info-message">üí≥ Voc√™ ainda n√£o tem cart√µes salvos</p>
          <div class="form-group">
            <label for="card-element">Informa√ß√µes do Cart√£o</label>
            <div id="card-element">
              <!-- Stripe Element ser√° inserido aqui -->
            </div>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="save-card" name="save-card" checked>
              Salvar este cart√£o para pr√≥ximas compras
            </label>
          </div>

          <div class="form-group">
            <label for="card-nickname">Apelido do cart√£o</label>
            <input type="text" id="card-nickname" name="card-nickname" placeholder="Ex: Cart√£o principal" value="Meu cart√£o">
          </div>
        </div>
        {% endif %}

        <div id="card-errors" class="error-message"></div>

        <button type="submit" class="btn-pagar" id="btn-submit">
          üîí Pagar R$ {{ "%.2f"|format(total) }}
        </button>

        <div id="loading" class="loading" style="display: none;">Processando pagamento...</div>
      </form>

      <div class="seguranca-info">
        üîí Pagamento seguro e criptografado
      </div>
    </div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{ stripe_public_key }}');
  const elements = stripe.elements();
  let cardElement = null;

  // Controlar exibi√ß√£o de endere√ßos salvos vs novo
  const addressOptions = document.querySelectorAll('input[name="address-option"]');
  const savedAddressList = document.getElementById('saved-addresses-list');
  const newAddressForm = document.getElementById('new-address-form');
  
  addressOptions.forEach(option => {
    option.addEventListener('change', (e) => {
      if (e.target.value === 'saved') {
        if (savedAddressList) savedAddressList.style.display = 'block';
        if (newAddressForm) newAddressForm.style.display = 'none';
      } else {
        if (savedAddressList) savedAddressList.style.display = 'none';
        if (newAddressForm) newAddressForm.style.display = 'block';
      }
    });
  });

  // Controlar exibi√ß√£o de cart√µes salvos vs novo
  const paymentOptions = document.querySelectorAll('input[name="payment-option"]');
  const savedPaymentList = document.getElementById('saved-payment-methods-list');
  const newCardForm = document.getElementById('new-card-form');
  
  paymentOptions.forEach(option => {
    option.addEventListener('change', (e) => {
      if (e.target.value === 'saved') {
        if (savedPaymentList) savedPaymentList.style.display = 'block';
        if (newCardForm) newCardForm.style.display = 'none';
        // Destruir Stripe Element se existir
        if (cardElement) {
          cardElement.destroy();
          cardElement = null;
        }
      } else {
        if (savedPaymentList) savedPaymentList.style.display = 'none';
        if (newCardForm) newCardForm.style.display = 'block';
        // Criar Stripe Element
        if (!cardElement) {
          createStripeElement();
        }
      }
    });
  });

  // Mostrar campo de apelido quando checkbox de salvar √© marcado
  const saveAddressCheckbox = document.getElementById('save-address');
  const addressNicknameGroup = document.getElementById('address-nickname-group');
  if (saveAddressCheckbox) {
    saveAddressCheckbox.addEventListener('change', (e) => {
      if (addressNicknameGroup) {
        addressNicknameGroup.style.display = e.target.checked ? 'block' : 'none';
      }
    });
  }

  const saveCardCheckbox = document.getElementById('save-card');
  const cardNicknameGroup = document.getElementById('card-nickname-group');
  if (saveCardCheckbox) {
    saveCardCheckbox.addEventListener('change', (e) => {
      if (cardNicknameGroup) {
        cardNicknameGroup.style.display = e.target.checked ? 'block' : 'none';
      }
    });
  }

  function createStripeElement() {
    cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#32325d',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#e74c3c'
        }
      }
    });

    cardElement.mount('#card-element');

    cardElement.on('change', function(event) {
      const errorDiv = document.getElementById('card-errors');
      if (event.error) {
        errorDiv.textContent = event.error.message;
      } else {
        errorDiv.textContent = '';
      }
    });
  }

  // Se n√£o tem cart√µes salvos OU se a op√ß√£o "novo" est√° marcada, criar elemento
  const hasPaymentOption = document.querySelector('input[name="payment-option"]');
  if (!hasPaymentOption || (hasPaymentOption && hasPaymentOption.value === 'new')) {
    createStripeElement();
  }

  // Processar pagamento
  const form = document.getElementById('payment-form');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btnSubmit = document.getElementById('btn-submit');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('card-errors');
    
    // Desabilita bot√£o e mostra loading
    btnSubmit.disabled = true;
    loadingDiv.style.display = 'block';
    errorDiv.textContent = '';

    try {
      let paymentData = {};

      // Verificar se usa endere√ßo salvo ou novo
      const addressOption = document.querySelector('input[name="address-option"]:checked');
      const usingSavedAddress = addressOption && addressOption.value === 'saved';
      
      if (usingSavedAddress) {
        const savedAddressId = document.querySelector('input[name="saved-address-id"]:checked');
        if (!savedAddressId) {
          throw new Error('Selecione um endere√ßo');
        }
        paymentData.saved_address_id = parseInt(savedAddressId.value);
      } else {
        // Validar campos de endere√ßo
        const rua = document.getElementById('rua').value.trim();
        const numero = document.getElementById('numero').value.trim();
        const bairro = document.getElementById('bairro').value.trim();
        const cidade = document.getElementById('cidade').value.trim();
        const telefone = document.getElementById('telefone').value.trim();

        if (!rua || !numero || !bairro || !cidade || !telefone) {
          throw new Error('Por favor, preencha todos os campos obrigat√≥rios do endere√ßo');
        }

        paymentData.endereco = {
          rua: rua,
          numero: numero,
          complemento: document.getElementById('complemento').value.trim(),
          bairro: bairro,
          cidade: cidade,
          telefone: telefone
        };

        // Verificar se quer salvar endere√ßo
        const saveAddress = document.getElementById('save-address');
        if (saveAddress && saveAddress.checked) {
          paymentData.save_address = true;
          const addressNickname = document.getElementById('address-nickname');
          paymentData.address_nickname = addressNickname ? addressNickname.value.trim() || 'Meu endere√ßo' : 'Meu endere√ßo';
        }
      }

      // Verificar se usa cart√£o salvo ou novo
      const paymentOption = document.querySelector('input[name="payment-option"]:checked');
      const usingSavedCard = paymentOption && paymentOption.value === 'saved';
      
      if (usingSavedCard) {
        const savedPaymentId = document.querySelector('input[name="saved-payment-method-id"]:checked');
        if (!savedPaymentId) {
          throw new Error('Selecione um cart√£o');
        }
        paymentData.saved_payment_method_id = parseInt(savedPaymentId.value);
      } else {
        // Criar payment method com Stripe Elements
        if (!cardElement) {
          throw new Error('Cart√£o n√£o carregado. Recarregue a p√°gina.');
        }

        const {paymentMethod, error} = await stripe.createPaymentMethod({
          type: 'card',
          card: cardElement
        });

        if (error) {
          throw new Error(error.message);
        }

        paymentData.payment_method_id = paymentMethod.id;

        // Verificar se quer salvar cart√£o
        const saveCard = document.getElementById('save-card');
        if (saveCard && saveCard.checked) {
          paymentData.save_card = true;
          const cardNickname = document.getElementById('card-nickname');
          paymentData.card_nickname = cardNickname ? cardNickname.value.trim() || 'Meu cart√£o' : 'Meu cart√£o';
        }
      }

      // Enviar para o servidor
      const response = await fetch('/processar-pagamento', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData)
      });

      const result = await response.json();

      if (result.success) {
        // Redireciona para p√°gina de sucesso
        window.location.href = '/pagamento/sucesso?pedido_id=' + result.pedido_id;
      } else {
        throw new Error(result.error || 'Erro ao processar pagamento');
      }
    } catch (error) {
      errorDiv.textContent = error.message;
      btnSubmit.disabled = false;
      loadingDiv.style.display = 'none';
    }
  });
</script>

<style>
.checkout-page {
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px;
}

.checkout-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  margin-top: 30px;
}

.resumo-pedido, .form-pagamento {
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.resumo-pedido h3, .form-pagamento h3 {
  margin-bottom: 20px;
  color: #333;
  font-size: 1.4em;
}

.endereco-section, .payment-method-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 25px;
}

.saved-options {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.option-card {
  flex: 1;
  padding: 15px;
  background: white;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.option-card:hover {
  border-color: #f39c12;
  transform: translateY(-2px);
}

.option-card input[type="radio"] {
  width: auto;
  margin: 0;
}

.option-card input[type="radio"]:checked ~ span {
  font-weight: bold;
  color: #f39c12;
}

.saved-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 15px;
}

.saved-item {
  background: white;
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.saved-item:hover {
  border-color: #f39c12;
  box-shadow: 0 3px 10px rgba(243,156,18,0.2);
}

.saved-item.default-item {
  border-color: #f39c12;
  background: #fffbf0;
}

.saved-item input[type="radio"] {
  margin-top: 3px;
  width: auto;
}

.saved-item-content {
  flex: 1;
}

.saved-item-content strong {
  display: inline-block;
  margin-bottom: 5px;
  color: #333;
  font-size: 1.05em;
}

.saved-item-details {
  color: #666;
  font-size: 0.9em;
  line-height: 1.6;
}

.badge-default {
  display: inline-block;
  background: #f39c12;
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  margin-left: 8px;
  font-weight: normal;
}

.badge-expired {
  display: inline-block;
  background: #e74c3c;
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  margin-left: 8px;
  font-weight: normal;
}

.form-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px dashed #ddd;
}

.info-message {
  background: #fff3cd;
  color: #856404;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 15px;
  border-left: 4px solid #ffc107;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.form-row {
  display: flex;
  gap: 15px;
}

.form-row .form-group {
  flex: 1;
}

.item-resumo {
  display: flex;
  justify-content: space-between;
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}

.total-pedido {
  display: flex;
  justify-content: space-between;
  padding-top: 20px;
  font-size: 1.3em;
  color: #f39c12;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #555;
  font-weight: 500;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  transition: border-color 0.3s;
}

#card-element {
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  background: white;
  transition: border-color 0.3s;
}

#card-element.StripeElement--focus {
  border-color: #f39c12;
}

#card-element.StripeElement--invalid {
  border-color: #e74c3c;
}

.form-group input:focus {
  outline: none;
  border-color: #f39c12;
}

.btn-pagar {
  width: 100%;
  padding: 15px;
  background: linear-gradient(135deg, #f39c12, #e67e22);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1em;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn-pagar:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(243,156,18,0.3);
}

.btn-pagar:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

.error-message {
  color: #e74c3c;
  margin-top: 15px;
  padding: 10px;
  background: #fee;
  border-radius: 5px;
  display: none;
}

.error-message:not(:empty) {
  display: block;
}

.loading {
  text-align: center;
  color: #f39c12;
  margin-top: 15px;
  font-weight: 500;
}

.seguranca-info {
  text-align: center;
  margin-top: 20px;
  color: #27ae60;
  font-size: 0.9em;
}

@media (max-width: 768px) {
  .checkout-container {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    flex-direction: column;
  }
  
  .saved-options {
    flex-direction: column;
  }
}
</style>
{% endblock %}
