{% extends "base.html" %}
{% block content %}
<section id="produto-detalhe" class="produto-detalhe">
  <div id="produto-info"></div>
  <div id="produto-reviews"></div>
  <div id="avaliar-area"></div>
</section>

<script>
const productId = {{ product_id }};
const token = localStorage.getItem('token');

// --------------------------------------------------
// MOSTRA DETALHES DO PRODUTO
// --------------------------------------------------
function showProduct(p) {
  const container = document.getElementById('produto-info');
  container.innerHTML = `
    <div class="card-detalhe">
      <img src="/static/imagens/${p.imagem}" alt="${p.titulo}">
      <div class="detalhes">
        <h2>${p.titulo}</h2>
        <p>${p.descricao}</p>
        <div class="preco">R$ ${p.preco.toFixed(2)}</div>
        <a class="botao-comprar" href="${p.mercado_pago_link || '#'}" target="_blank">Comprar no Mercado Pago</a>
        <button id="btn-simular-compra" class="botao-comprar">Simular Compra (para avaliar)</button>
      </div>
    </div>
  `;

  document.getElementById('btn-simular-compra').onclick = async () => {
    if (!token) {
      alert('Faça login para simular a compra e avaliar.');
      return;
    }
    const res = await fetch('/api/purchase', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ product_id: productId })
    });
    const j = await res.json();
    alert(j.message || 'OK');
    if (res.ok) showAvaliacaoArea(); // recarrega área de avaliação
  };
}

// --------------------------------------------------
// MOSTRA AVALIAÇÕES EXISTENTES
// --------------------------------------------------
function showReviews(list) {
  const c = document.getElementById('produto-reviews');
  c.innerHTML = '<h3>Avaliações</h3>';
  if (!list || list.length === 0) {
    c.innerHTML += '<p>Nenhuma avaliação ainda.</p>';
    return;
  }
  list.forEach(r => {
    const div = document.createElement('div');
    div.className = 'comentario';
    div.innerHTML = `<strong>${r.nome}</strong> • ${r.nota} ⭐<br/><em>${r.comentario || ''}</em>`;
    c.appendChild(div);
  });
}

// --------------------------------------------------
// MOSTRA FORMULÁRIO DE AVALIAÇÃO (SE TIVER COMPRADO)
// --------------------------------------------------
async function showAvaliacaoArea() {
  const area = document.getElementById('avaliar-area');
  area.innerHTML = '';

  if (!token) {
    area.innerHTML = '<p>Faça login para avaliar após comprar.</p>';
    return;
  }

  // Verifica se o usuário comprou o produto
  const res = await fetch('/api/me', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const userData = await res.json();
  const comprou = userData.compras?.some(c => c.product_id === productId);

  if (!comprou) {
    area.innerHTML = `<p>⚠️ Você só pode avaliar produtos que comprou. Clique em "Simular Compra" para testar.</p>`;
    return;
  }

  // Mostra o formulário de avaliação
  area.innerHTML = `
    <h3>Deixe sua avaliação</h3>
    <label>Nota:
      <select id="nota">
        <option value="">Selecione</option>
        <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
      </select>
    </label>
    <textarea id="comentario" placeholder="Comentário (opcional)"></textarea>
    <button id="btn-avaliar" class="botao-comprar">Enviar Avaliação</button>
  `;

  document.getElementById('btn-avaliar').onclick = async () => {
    const nota = document.getElementById('nota').value;
    const comentario = document.getElementById('comentario').value;

    if (!nota) {
      alert('Selecione uma nota antes de enviar!');
      return;
    }

    const res = await fetch('/api/review', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ product_id: productId, nota, comentario })
    });
    const j = await res.json();
    alert(j.message || JSON.stringify(j));
    if (res.ok) location.reload();
  };
}

// --------------------------------------------------
// INICIALIZA A PÁGINA
// --------------------------------------------------
fetch(`/api/product/${productId}`)
  .then(r => r.json())
  .then(data => {
    showProduct(data);
    showReviews(data.reviews || []);
    showAvaliacaoArea();
  });
</script>
{% endblock %}
