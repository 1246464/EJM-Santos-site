{% extends "base.html" %}
{% block content %}
<section class="perfil">
  <div class="perfil-container">
    <div class="perfil-header">
      <h2>üë§ Meu Perfil</h2>
      <button id="btn-logout" class="btn-logout">Sair</button>
    </div>

    <div class="perfil-info" id="perfil-info">
      <p>Carregando suas informa√ß√µes...</p>
    </div>

    <div class="perfil-section">
      <h3>üõí Minhas Compras</h3>
      <ul id="minhas-compras" class="lista-compras"></ul>
    </div>

    <div class="perfil-section">
      <h3>‚≠ê Minhas Avalia√ß√µes</h3>
      <ul id="minhas-avaliacoes" class="lista-avaliacoes"></ul>
    </div>
  </div>
</section>

<style>
  .perfil { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
  .perfil-container { background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.08); padding: 24px; }
  .perfil-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
  .perfil-header h2 { margin: 0; font-size: 1.6rem; color: #333; }
  .btn-logout { background: #e53935; color: #fff; border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer; }
  .btn-logout:hover { background: #d32f2f; }
  .perfil-info p { margin: 6px 0; font-size: 1rem; color: #444; }
  .perfil-section h3 { margin-top: 24px; color: #222; }
  ul { list-style: none; padding: 0; margin: 0; }
  li { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 12px; margin: 8px 0; }
  a { color: #0077cc; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>

<script>
const token = localStorage.getItem('token');

if (!token) {
  document.getElementById('perfil-info').innerHTML = '<p>Voc√™ n√£o est√° logado. <a href="/login">Entrar</a></p>';
} else {
  fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token }})
    .then(r => r.json())
    .then(u => {
      if(u.message){
        document.getElementById('perfil-info').innerHTML = '<p>Erro: ' + u.message + '</p>';
        return;
      }

      // Dados do usu√°rio
      document.getElementById('perfil-info').innerHTML = `
        <p><strong>Nome:</strong> ${u.nome}</p>
        <p><strong>Email:</strong> ${u.email}</p>
      `;

      // Compras
      const ulCompras = document.getElementById('minhas-compras');
      if (!u.compras || u.compras.length === 0) {
        ulCompras.innerHTML = '<li>Nenhuma compra registrada.</li>';
      } else {
        u.compras.forEach(c => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="/produto/${c.product_id}">${c.titulo}</a>`;
          ulCompras.appendChild(li);
        });
      }

      // Avalia√ß√µes (opcional: puxa de /api/review/me)
      fetch('/api/reviews/me', { headers: { 'Authorization': 'Bearer ' + token }})
        .then(r => r.ok ? r.json() : [])
        .then(revs => {
          const ul = document.getElementById('minhas-avaliacoes');
          if (!revs || revs.length === 0) {
            ul.innerHTML = '<li>Voc√™ ainda n√£o avaliou nenhum produto.</li>';
          } else {
            revs.forEach(r => {
              const li = document.createElement('li');
              li.innerHTML = `<strong>${r.titulo}</strong> ‚Äî ${r.nota}‚≠ê<br>${r.comentario}`;
              ul.appendChild(li);
            });
          }
        });
    })
    .catch(err => {
      console.error(err);
      document.getElementById('perfil-info').innerHTML = '<p>Erro ao carregar informa√ß√µes.</p>';
    });
}

document.getElementById('btn-logout').onclick = () => {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location = '/login';
};
</script>
{% endblock %}
