{% extends "base.html" %}
{% block content %}

<section class="painel-admin">
  <div class="painel-wrap">
    <h2>üì¶ Painel Administrativo</h2>
    <p>Bem-vindo, {{ session['user_name'] }}!</p>

    <div class="top-bar">
      <a href="/admin/novo" class="btn-add">‚ûï Novo Produto</a>
      <a href="/logout" class="btn-logout">Sair</a>
    </div>

    <!-- Busca Admin -->
    <div class="busca-admin">
      <input type="text" id="busca-admin" placeholder="üîç Buscar produtos por t√≠tulo ou ID..." />
    </div>

    <table class="tabela-admin" id="tabela-produtos">
      <thead>
        <tr>
          <th>ID</th>
          <th>T√≠tulo</th>
          <th>Pre√ßo</th>
          <th>Estoque</th>
          <th>Imagem</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tbody-produtos">
        {% for p in produtos %}
        <tr data-id="{{ p.id }}" data-titulo="{{ p.titulo|lower }}">
          <td>{{ p.id }}</td>
          <td>{{ p.titulo }}</td>
          <td>R$ {{ "%.2f"|format(p.preco) }}</td>
          <td>
            <span class="badge-estoque-admin {% if p.estoque <= 0 %}esgotado{% elif p.estoque < 10 %}baixo{% endif %}">
              {{ p.estoque }} un
            </span>
          </td>
          <td>
            {% if p.imagem %}
              <img src="/static/{{ p.imagem }}" alt="{{ p.titulo }}">
            {% else %}-{% endif %}
          </td>
          <td class="acoes">
            <a href="/admin/editar/{{ p.id }}" class="btn-editar">‚úèÔ∏è</a>
            <a href="/admin/remover/{{ p.id }}" class="btn-excluir"
               onclick="return confirm('Deseja remover este produto?')">üóëÔ∏è</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</section> <!-- ‚úÖ FECHAMENTO CORRETO AQUI -->

<section class="dashboard-cards">
  <div class="cardDM">üì¶ Pedidos <h3>{{ total_pedidos }}</h3></div>
  <div class="cardDM">üí≥ Pagos <h3>{{ total_pago }}</h3></div>
  <div class="cardDM">üöö Enviados <h3>{{ enviados }}</h3></div>
  <div class="cardDM">‚úÖ Entregues <h3>{{ entregues }}</h3></div>
  <div class="cardDM">‚ùå Cancelados <h3>{{ cancelados }}</h3></div>
  <div class="cardDM">üí∞ Faturamento <h3>R$ {{ "%.2f"|format(faturamento) }}</h3></div>
  <div class="cardDM">üìä Ticket M√©dio <h3>R$ {{ "%.2f"|format(ticket_medio) }}</h3></div>
</section>

<section class="grafico-box">
  <h3>üìà Faturamento dos √∫ltimos 6 meses</h3>
  <canvas id="chartFaturamento"></canvas>
</section>

<style>
  .painel-wrap {
    padding: 25px;
    background: #fff;
    border-radius: 14px;
    max-width: 1100px;
    margin: 30px auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  }

  .top-bar { display: flex; justify-content: space-between; margin: 12px 0; }
  .btn-add { background: #f6b800; padding: 10px 18px; border-radius: 8px; font-weight: 600; }
  .btn-logout { background: #e53935; color:#fff; padding:10px 18px; border-radius:8px; font-weight:600; }

  .busca-admin { margin: 20px 0; }
  .busca-admin input {
    width: 100%;
    padding: 12px 20px;
    border: 2px solid #ddd;
    border-radius: 25px;
    font-size: 1em;
    transition: all 0.3s;
  }
  .busca-admin input:focus {
    outline: none;
    border-color: #f6b800;
    box-shadow: 0 0 10px rgba(246,184,0,0.2);
  }

  .tabela-admin { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 15px; }
  .tabela-admin th {
    padding: 10px;
    background: #222;
    color: #f6b800;
    font-weight: 600;
    text-align: left;
  }
  .tabela-admin td {
    padding: 12px 10px;
    border-bottom: 1px solid #ddd;
  }
  .tabela-admin img { width: 60px; border-radius: 8px; }

  .acoes a { font-size: 18px; margin-right: 8px; text-decoration: none; }

  .badge-estoque-admin {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
    background: #d4edda;
    color: #155724;
  }
  .badge-estoque-admin.baixo {
    background: #fff3cd;
    color: #856404;
  }
  .badge-estoque-admin.esgotado {
    background: #fee;
    color: #c00;
  }

  .dashboard-cards {
    max-width: 1100px;
    margin: 20px auto;
    display: grid;
    gap: 18px;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  }
  .cardDM {
    background: #fff;
    border-radius: 12px;
    text-align: center;
    padding: 20px 10px;
    font-weight: 700;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    color: #222;
  }
  .cardDM h3 { margin-top: 8px; font-size: 22px; color: #f6b800; }

  .grafico-box {
    max-width: 1100px;
    margin: 35px auto;
    background: #fff;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  }
  .grafico-box h3 {
    margin-bottom: 15px;
    font-weight: 700;
    color: #222;
  }

  /* Hover nice */
  .cardDM:hover, .tabela-admin tr:hover { transform: scale(1.01); transition: 0.2s; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Busca em tempo real no admin
document.getElementById('busca-admin').addEventListener('input', function() {
  const busca = this.value.toLowerCase();
  const linhas = document.querySelectorAll('#tbody-produtos tr');
  
  linhas.forEach(linha => {
    const id = linha.getAttribute('data-id');
    const titulo = linha.getAttribute('data-titulo');
    
    if (id.includes(busca) || titulo.includes(busca)) {
      linha.style.display = '';
    } else {
      linha.style.display = 'none';
    }
  });
});

const ctx = document.getElementById('chartFaturamento').getContext('2d');

new Chart(ctx, {
  type: 'bar',
  data: {
    labels: {{ meses_labels|tojson }},
    datasets: [{
      label: 'R$ Faturado no m√™s',
      data: {{ meses_valores|tojson }},
      backgroundColor: '#f6b800',
      borderRadius: 8,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false }},
    scales: {
      y: {
        beginAtZero: true,
        ticks: { callback: value => 'R$ ' + value.toFixed(2) }
      }
    }
  }
});
</script>

{% endblock %}
